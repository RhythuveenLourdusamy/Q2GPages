{"uid":"43dddf55218e6398","name":"test_single_turn_case[AGGREGATE_FUNCTION_WITH_TIME-Give me the average Public Notes Count of Tickets in the last 60 seconds-545-expected_json544-SELECT AVG(Public Notes Count) FROM freshservice.Tickets WHERE  `Created Date` >= CURRENT_TIMESTAMP - INTERVAL '60 second']","fullName":"tests.q2g.jeeves_singleturn_test#test_single_turn_case","historyId":"0532181ca5f1eb741af9165918ab98ab","time":{"start":1729006489674,"stop":1729006543604,"duration":53930},"status":"failed","statusMessage":"Failed: API failed due to repeated 504 responses.","statusTrace":"use_case = 'AGGREGATE_FUNCTION_WITH_TIME'\nuser_question = 'Give me the average Public Notes Count of Tickets in the last 60 seconds'\ntest_case = 545\nexpected_json = {'from': [{'name': 'Tickets', 'product': 'freshservice', 'resource': 'Tickets', 'type': 'RESOURCE'}], 'resources': {'T...TION'}, {'type': 'INTERVAL', 'unit': 'second', 'value': 60}], 'name': 'SUB', 'type': 'FUNCTION'}, 'type': 'CONDITION'}}\nexpected_sql = \"SELECT AVG(Public Notes Count) FROM freshservice.Tickets WHERE  `Created Date` >= CURRENT_TIMESTAMP - INTERVAL '60 second'\"\n\n    @pytest.mark.parametrize(\n        \"use_case, user_question, test_case, expected_json, expected_sql\",\n        ConversationAPIHelper.load_test_cases_data(product) # Kindly add the filter in template_mapper.json file before using it\n    )\n    @allure.step(\"Test single-turn conversation API\")\n    def test_single_turn_case(use_case, user_question, test_case, expected_json, expected_sql):\n>       base_conversation_test.common_test_logic(use_case, user_question, test_case, expected_json)\n\ntests/q2g/jeeves_singleturn_test.py:17: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nutils/q2g_helper/BaseConversationTest.py:13: in common_test_logic\n    response = self.api_helper.get_response_json(user_question, test_case)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <utils.ConversationAPIHelper.ConversationAPIHelper object at 0x121ee7620>\nuser_question = 'Give me the average Public Notes Count of Tickets in the last 60 seconds'\ntest_case = 545\n\n    def get_response_json(self, user_question, test_case):\n        \"\"\"\n        Helper method to construct the request, make the API call, handle retries, and return the response JSON.\n        \"\"\"\n        # Construct request body and headers\n        global jeeves_wf_id\n        request_body = self.construct_request_body(user_question)\n        # Check if the test_case has been encountered before\n        if test_case is None or test_case not in self.test_case_uuid_map:\n            # If not, generate a new UUID and store it\n            self.test_case_uuid_map[test_case] = str(uuid.uuid4())\n    \n        # Return the previously generated or newly generated UUID\n        dialog_source = self.test_case_uuid_map[test_case]\n        headers = self.construct_headers(dialog_source)\n    \n        retries = 0\n        while retries < MAX_RETRIES:\n            # Make the API call\n            response = self.api_helper.post(\n                url=self.get_jeeves_base_url() + \"/v1/api/analytics/conversation\",\n                headers=headers,\n                body=json.dumps(request_body)\n            )\n            if response.headers.__contains__('jeeves_wf_id'):\n                jeeves_wf_id = response.headers['jeeves-wf-id']\n                print(f\"JEEVES_WF_ID {jeeves_wf_id}\")\n    \n    \n            # Retry on 504 or 502 response\n            if response.status_code in (504, 502):\n                retries += 1\n                if retries < MAX_RETRIES:\n                    print(f\"Received {response.status_code} response, retrying {retries}/{MAX_RETRIES} after 10 \"\n                          f\"seconds...\")\n                    time.sleep(10)  # Wait before retrying\n                    continue\n                else:\n                    print(f\"Max retries ({MAX_RETRIES}) reached.\")\n>                   pytest.fail(f\"API failed due to repeated {response.status_code} responses.\\n\")\nE                   Failed: API failed due to repeated 504 responses.\n\nutils/ConversationAPIHelper.py:66: Failed","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"_session_faker","time":{"start":1729004625624,"stop":1729004625767,"duration":143},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"attachmentStep":false}],"testStage":{"status":"failed","statusMessage":"Failed: API failed due to repeated 504 responses.","statusTrace":"use_case = 'AGGREGATE_FUNCTION_WITH_TIME'\nuser_question = 'Give me the average Public Notes Count of Tickets in the last 60 seconds'\ntest_case = 545\nexpected_json = {'from': [{'name': 'Tickets', 'product': 'freshservice', 'resource': 'Tickets', 'type': 'RESOURCE'}], 'resources': {'T...TION'}, {'type': 'INTERVAL', 'unit': 'second', 'value': 60}], 'name': 'SUB', 'type': 'FUNCTION'}, 'type': 'CONDITION'}}\nexpected_sql = \"SELECT AVG(Public Notes Count) FROM freshservice.Tickets WHERE  `Created Date` >= CURRENT_TIMESTAMP - INTERVAL '60 second'\"\n\n    @pytest.mark.parametrize(\n        \"use_case, user_question, test_case, expected_json, expected_sql\",\n        ConversationAPIHelper.load_test_cases_data(product) # Kindly add the filter in template_mapper.json file before using it\n    )\n    @allure.step(\"Test single-turn conversation API\")\n    def test_single_turn_case(use_case, user_question, test_case, expected_json, expected_sql):\n>       base_conversation_test.common_test_logic(use_case, user_question, test_case, expected_json)\n\ntests/q2g/jeeves_singleturn_test.py:17: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nutils/q2g_helper/BaseConversationTest.py:13: in common_test_logic\n    response = self.api_helper.get_response_json(user_question, test_case)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <utils.ConversationAPIHelper.ConversationAPIHelper object at 0x121ee7620>\nuser_question = 'Give me the average Public Notes Count of Tickets in the last 60 seconds'\ntest_case = 545\n\n    def get_response_json(self, user_question, test_case):\n        \"\"\"\n        Helper method to construct the request, make the API call, handle retries, and return the response JSON.\n        \"\"\"\n        # Construct request body and headers\n        global jeeves_wf_id\n        request_body = self.construct_request_body(user_question)\n        # Check if the test_case has been encountered before\n        if test_case is None or test_case not in self.test_case_uuid_map:\n            # If not, generate a new UUID and store it\n            self.test_case_uuid_map[test_case] = str(uuid.uuid4())\n    \n        # Return the previously generated or newly generated UUID\n        dialog_source = self.test_case_uuid_map[test_case]\n        headers = self.construct_headers(dialog_source)\n    \n        retries = 0\n        while retries < MAX_RETRIES:\n            # Make the API call\n            response = self.api_helper.post(\n                url=self.get_jeeves_base_url() + \"/v1/api/analytics/conversation\",\n                headers=headers,\n                body=json.dumps(request_body)\n            )\n            if response.headers.__contains__('jeeves_wf_id'):\n                jeeves_wf_id = response.headers['jeeves-wf-id']\n                print(f\"JEEVES_WF_ID {jeeves_wf_id}\")\n    \n    \n            # Retry on 504 or 502 response\n            if response.status_code in (504, 502):\n                retries += 1\n                if retries < MAX_RETRIES:\n                    print(f\"Received {response.status_code} response, retrying {retries}/{MAX_RETRIES} after 10 \"\n                          f\"seconds...\")\n                    time.sleep(10)  # Wait before retrying\n                    continue\n                else:\n                    print(f\"Max retries ({MAX_RETRIES}) reached.\")\n>                   pytest.fail(f\"API failed due to repeated {response.status_code} responses.\\n\")\nE                   Failed: API failed due to repeated 504 responses.\n\nutils/ConversationAPIHelper.py:66: Failed","steps":[{"name":"Test single-turn conversation API","time":{"start":1729006489675,"stop":1729006543603,"duration":53928},"status":"failed","statusMessage":"Failed: API failed due to repeated 504 responses.\n\n","statusTrace":"  File \"/Users/rl/PycharmProjects/auroraTestAutomation/APIautomation/lib/python3.12/site-packages/allure_commons/_allure.py\", line 192, in impl\n    return func(*a, **kw)\n           ^^^^^^^^^^^^^^\n  File \"/Users/rl/Documents/GitHub/jeeves_automation/tests/q2g/jeeves_singleturn_test.py\", line 17, in test_single_turn_case\n    base_conversation_test.common_test_logic(use_case, user_question, test_case, expected_json)\n  File \"/Users/rl/Documents/GitHub/jeeves_automation/utils/q2g_helper/BaseConversationTest.py\", line 13, in common_test_logic\n    response = self.api_helper.get_response_json(user_question, test_case)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/rl/Documents/GitHub/jeeves_automation/utils/ConversationAPIHelper.py\", line 66, in get_response_json\n    pytest.fail(f\"API failed due to repeated {response.status_code} responses.\\n\")\n  File \"/Users/rl/PycharmProjects/auroraTestAutomation/APIautomation/lib/python3.12/site-packages/_pytest/outcomes.py\", line 177, in fail\n    raise Failed(msg=reason, pytrace=pytrace)\n","steps":[],"attachments":[],"parameters":[{"name":"use_case","value":"'AGGREGATE_FUNCTION_WITH_TIME'"},{"name":"user_question","value":"'Give me the average Public Notes Count of Tickets in the last 60 seconds'"},{"name":"test_case","value":"545"},{"name":"expected_json","value":"{'select': [{'name': 'AVG', 'arguments': [{'resource': 'Tickets', 'name': 'Public Notes Count', 'type': 'FIELD'}], 'type': 'FUNCTION'}], 'from': [{'product': 'freshservice', 'resource': 'Tickets', 'name': 'Tickets', 'type': 'RESOURCE'}], 'where': {'lhs': {'resource': 'Tickets', 'name': 'Created Date', 'type': 'FIELD'}, 'type': 'CONDITION', 'rhs': {'name': 'SUB', 'arguments': [{'name': 'CURRENT_TIMESTAMP', 'arguments': [], 'type': 'FUNCTION'}, {'unit': 'second', 'type': 'INTERVAL', 'value': 60}], 'type': 'FUNCTION'}, 'operator': 'GTE'}, 'resources': {'Tickets': {'product': 'freshservice', 'name': 'Tickets'}}}"},{"name":"expected_sql","value":"'SELECT AVG(Public Notes Count) FROM freshservice.Tickets WHERE  `Created Date` >= CURRENT_TIMESTAMP - INTERVAL '60 second''"}],"hasContent":true,"shouldDisplayMessage":true,"stepsCount":0,"attachmentsCount":0,"attachmentStep":false}],"attachments":[{"uid":"ce1bea7cad389137","name":"stdout","source":"ce1bea7cad389137.txt","type":"text/plain","size":3093}],"parameters":[],"hasContent":true,"shouldDisplayMessage":true,"stepsCount":1,"attachmentsCount":1,"attachmentStep":false},"afterStages":[],"labels":[{"name":"parentSuite","value":"tests.q2g"},{"name":"suite","value":"jeeves_singleturn_test"},{"name":"host","value":"FWS-CHE-LT-6357"},{"name":"thread","value":"87160-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.q2g.jeeves_singleturn_test"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"expected_json","value":"{'select': [{'name': 'AVG', 'arguments': [{'resource': 'Tickets', 'name': 'Public Notes Count', 'type': 'FIELD'}], 'type': 'FUNCTION'}], 'from': [{'product': 'freshservice', 'resource': 'Tickets', 'name': 'Tickets', 'type': 'RESOURCE'}], 'where': {'lhs': {'resource': 'Tickets', 'name': 'Created Date', 'type': 'FIELD'}, 'type': 'CONDITION', 'rhs': {'name': 'SUB', 'arguments': [{'name': 'CURRENT_TIMESTAMP', 'arguments': [], 'type': 'FUNCTION'}, {'unit': 'second', 'type': 'INTERVAL', 'value': 60}], 'type': 'FUNCTION'}, 'operator': 'GTE'}, 'resources': {'Tickets': {'product': 'freshservice', 'name': 'Tickets'}}}"},{"name":"expected_sql","value":"'SELECT AVG(Public Notes Count) FROM freshservice.Tickets WHERE  `Created Date` >= CURRENT_TIMESTAMP - INTERVAL '60 second''"},{"name":"test_case","value":"545"},{"name":"use_case","value":"'AGGREGATE_FUNCTION_WITH_TIME'"},{"name":"user_question","value":"'Give me the average Public Notes Count of Tickets in the last 60 seconds'"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"tags":[]},"source":"43dddf55218e6398.json","parameterValues":["{'select': [{'name': 'AVG', 'arguments': [{'resource': 'Tickets', 'name': 'Public Notes Count', 'type': 'FIELD'}], 'type': 'FUNCTION'}], 'from': [{'product': 'freshservice', 'resource': 'Tickets', 'name': 'Tickets', 'type': 'RESOURCE'}], 'where': {'lhs': {'resource': 'Tickets', 'name': 'Created Date', 'type': 'FIELD'}, 'type': 'CONDITION', 'rhs': {'name': 'SUB', 'arguments': [{'name': 'CURRENT_TIMESTAMP', 'arguments': [], 'type': 'FUNCTION'}, {'unit': 'second', 'type': 'INTERVAL', 'value': 60}], 'type': 'FUNCTION'}, 'operator': 'GTE'}, 'resources': {'Tickets': {'product': 'freshservice', 'name': 'Tickets'}}}","'SELECT AVG(Public Notes Count) FROM freshservice.Tickets WHERE  `Created Date` >= CURRENT_TIMESTAMP - INTERVAL '60 second''","545","'AGGREGATE_FUNCTION_WITH_TIME'","'Give me the average Public Notes Count of Tickets in the last 60 seconds'"]}